#!/usr/bin/python
# -*- coding:UTF-8 -*-

import AutoExecUtils
import os
import sys
import traceback
import datetime
import argparse
import sys
import json
from bson import ObjectId
from bson.json_util import dumps, loads


def genInsRel(db):
    insCollection = db['COLLECT_INS']
    relSrcCollection = db['RELATION_INS_NETCONN']
    relDestCollection = db['RELATION_INS_NETCONN']
    clusterCollection = db['COLLECT_CLUSTER']

    for ins in relSrcCollection.find({}, {'OS_ID': 1,
                                          'MGMT_IP': 1,
                                          'PORT': 1,
                                          'PEER': 1}).batch_size(500):
        # print(dumps(ins))
        peer = ins['PEER']

        refIns = []
        refDbs = []
        refCls = []
        for rel in relDestCollection.find({'BIND':
                                           {'$in': peer}
                                           },
                                          {'OS_ID': 1,
                                           'MGMT_IP': 1,
                                           'PORT': 1,
                                           '_OBJ_CATEGORY': 1,
                                           '_OBJ_TYPE': 1}
                                          ).batch_size(500):

            refInfo = {'_OBJ_CATEGORY': rel['_OBJ_CATEGORY'],
                       '_OBJ_TYPE': rel['_OBJ_TYPE'],
                       'OS_ID': rel['OS_ID'],
                       'MGMT_IP': rel['MGMT_IP'],
                       'PORT': rel['PORT']
                       }

            if rel['_OBJ_CATEGORY'] == 'DB':
                refDbs.append(refInfo)
            else:
                refIns.append(refInfo)

        for cluster in clusterCollection.find({'BIND':
                                               {'$in': peer}
                                               }, {'UNIQUE_NAME': 1,
                                                   'VIP': 1,
                                                   'PORT': 1,
                                                   '_OBJ_CATEGORY': 1,
                                                   '_OBJ_TYPE': 1,
                                                   'CLUSTER_MODE': 1,
                                                   'CLUSTER_SOFTWARE': 1}
                                              ).batch_size(500):
            refInfo = {'_OBJ_CATEGORY': cluster['_OBJ_CATEGORY'],
                       '_OBJ_TYPE': cluster['_OBJ_TYPE'],
                       'UNIQUE_NAME': cluster['UNIQUE_NAME'],
                       'VIP': cluster['VIP'],
                       'PORT': cluster['PORT'],
                       'CLUSTER_MODE': cluster['CLUSTER_MODE'],
                       'CLUSTER_SOFTWARE': cluster['CLUSTER_SOFTWARE']
                       }
            refCls.append(refInfo)

        insCollection.update_one({'OS_ID': ins['OS_ID'],
                                  'MGMT_IP': ins['MGMT_IP'],
                                  'PORT': ins['PORT']},
                                 {'$set':
                                  {
                                      'REF_DB': refDbs,
                                      'REF_CLUSTER': refCls,
                                      'REF_INS': refIns
                                  }
                                  })


def genOSSwitchRel(db):
    osCollection = db['COLLECT_OS']
    macTblCollection = db['RELATION_NET_MACTABLE']
    osUpdCollection = db['COLLECT_OS']

    for os in osCollection.find({},
                                {'OS_ID': 1,
                                 'MGMT_IP': 1,
                                 'ETH_INTERFACES.MAC': 1
                                 }).batch_size(500):
        if 'ETH_INTERFACES' not in os:
            continue

        nics = os['ETH_INTERFACES']
        for nic in nics:
            macCount = sys.maxsize
            remotePort = None
            remotePort = macTblCollection.find_one({'MAC_TABLE.MACS': nic['MAC'],
                                                    'MAC_TABLE.MAC_COUNT': 1},
                                                   {'_OBJ_CATEGORY': 1,
                                                    '_OBJ_TYPE': 1,
                                                    'MGMT_IP': 1,
                                                    'SN': 1,
                                                    'MAC_TABLE': {
                                                        '$elemMatch': {'MACS': nic['MAC'],
                                                                       'MAC_COUNT': 1}
                                                    },
                                                    })

            refSwPorts = []
            refSwPort = {}
            if remotePort is not None and 'MAC_TABLE' in remotePort:
                refSwPort = {'_OBJ_CATEGORY': remotePort['_OBJ_CATEGORY'],
                             '_OBJ_TYPE': remotePort['_OBJ_TYPE'],
                             'MGMT_IP': remotePort['MGMT_IP'],
                             'SN': remotePort['SN'],
                             'PORT': remotePort['MAC_TABLE']['PORT']}
                refSwPorts.append(refSwPort)

            nic['REMOTE_PORTS'] = refSwPorts

        osUpdCollection.update_one({'OS_ID': os['OS_ID'], 'MGMT_IP': os['MGMT_IP']},
                                   {'$set':
                                    {'ETH_INTERFACES': nics}
                                    })


def genSwitchRel(db):
    cdpSrcCollection = db['COLLECT_SWITCH']
    cdpDestCollection = db['COLLECT_SWITCH']

    for swInfo in cdpSrcCollection.find({},
                                        {'MGMT_IP': 1,
                                         'SN': 1,
                                         'PORTS': 1
                                         }).batch_size(500):
        needUpdate = False
        ports = swInfo['PORTS']
        for port in ports:
            if 'NEIGHBORS' not in port:
                continue

            neighbors = port['NEIGHBORS']
            for neighbor in neighbors:
                if 'DEV_NAME' in neighbor:
                    remoteCount = 0
                    for dev in cdpDestCollection.find({'DEV_NAME': neighbor['DEV_NAME']},
                                                      {'_OBJ_CATEGORY': 1,
                                                       '_OBJ_TYPE': 1,
                                                       'MGMT_IP': 1,
                                                       'SN': 1}
                                                      ).limit(2):
                        remoteCount = remoteCount + 1
                    if remoteCount == 1:
                        needUpdate = True
                        neighbor['_OBJ_CATEGORY'] = dev['_OBJ_CATEGORY']
                        neighbor['_OBJ_TYPE'] = dev['_OBJ_TYPE']
                        neighbor['MGMT_IP'] = dev['MGMT_IP']
                        neighbor['SN'] = dev['SN']

        if needUpdate:
            cdpDestCollection.update_one({'MGMT_IP': swInfo['MGMT_IP'],
                                          'SN': swInfo['SN']},
                                         {'$set':
                                          {'PORTS': ports}
                                          })


if __name__ == "__main__":
    parser = argparse.ArgumentParser()
    parser.add_argument('--type', default='OS', help='关系类别[OS|NET]')
    args = parser.parse_args()

    (dbclient, db) = AutoExecUtils.getDB()

    try:
        if args.type == 'OS' or args.type is None:
            genInsRel(db)
            genOSSwitchRel(db)
        elif args.type == 'NET' or args.type is None:
            genSwitchRel(db)
    except Exception as ex:
        print('ERROR: Unknow Error, {}'.format(traceback.format_exc()))
        exit(-1)
    finally:
        if dbclient is not None:
            dbclient.close()
