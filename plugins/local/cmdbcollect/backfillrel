#!/usr/bin/python
# -*- coding:UTF-8 -*-

import AutoExecUtils
import os
import sys
import traceback
import datetime
import argparse
import sys
import json
from bson import ObjectId
from bson.json_util import dumps, loads


def genInsRel(db):
    insCollection = db['COLLECT_INS']
    relSrcCollection = db['RELATION_INS_NETCONN']
    relDestCollection = db['RELATION_INS_NETCONN']

    for ins in relSrcCollection.find({}, {'OS_ID': 1,
                                          'MGMT_IP': 1,
                                          'PORT': 1,
                                          'PEER': 1}).batch_size(500):
        # print(dumps(ins))
        peer = ins['PEER']

        refIns = []
        refDb = []
        for rel in relDestCollection.find({'BIND':
                                           {'$in': peer}
                                           },
                                          {'OS_ID': 1,
                                           'MGMT_IP': 1,
                                           'PORT': 1,
                                           '_OBJ_CATEGORY': 1,
                                           '_OBJ_TYPE': 1}
                                          ).batch_size(500):
            if rel['_OBJ_CATEGORY'] == 'DB':
                refIns.append({'_OBJ_CATEGORY': rel['_OBJ_CATEGORY'],
                               '_OBJ_TYPE': rel['_OBJ_TYPE'],
                               'OS_ID': rel['OS_ID'],
                               'MGMT_IP': rel['MGMT_IP'],
                               'PORT': rel['PORT']
                               })
            else:
                refDb.append({'_OBJ_CATEGORY': rel['_OBJ_CATEGORY'],
                              '_OBJ_TYPE': rel['_OBJ_TYPE'],
                              'OS_ID': rel['OS_ID'],
                              'MGMT_IP': rel['MGMT_IP'],
                              'PORT': rel['PORT']
                              })

        insCollection.update_one({'OS_ID': ins['OS_ID'],
                                  'MGMT_IP': ins['MGMT_IP'],
                                  'PORT': ins['PORT']},
                                 {'$set':
                                  {'REF_INS': refIns}
                                  })
        insCollection.update_one({'OS_ID': ins['OS_ID'],
                                  'MGMT_IP': ins['MGMT_IP'],
                                  'PORT': ins['PORT']},
                                 {'$set':
                                  {'REF_DB': refDb}
                                  })


def genOSSwitchRel(db):
    osCollection = db['COLLECT_OS']
    macTblCollection = db['RELATION_NET_MACTABLE']
    osUpdCollection = db['COLLECT_OS']

    for os in osCollection.find({},
                                {'OS_ID': 1,
                                 'MGMT_IP': 1,
                                 'ETH_INTERFACES.MAC': 1
                                 }).batch_size(500):
        nics = os['ETH_INTERFACES']
        for nic in nics:
            macCount = sys.maxsize
            remotePort = None
            remotePort = macTblCollection.find_one({'MAC_TABLE.MACS': nic['MAC'],
                                                    'MAC_TABLE.MAC_COUNT': 1},
                                                   {'_OBJ_CATEGORY': 1,
                                                    '_OBJ_TYPE': 1,
                                                    'MGMT_IP': 1,
                                                    'SN': 1,
                                                    'MAC_TABLE': {
                                                        '$elemMatch': {'MACS': nic['MAC'],
                                                                       'MAC_COUNT': 1}
                                                    },
                                                    })

            refSwPort = {}
            if remotePort is not None and 'MAC_TABLE' in remotePort:
                refSwPort = {'_OBJ_CATEGORY': remotePort['_OBJ_CATEGORY'],
                             '_OBJ_TYPE': remotePort['_OBJ_TYPE'],
                             'MGMT_IP': remotePort['MGMT_IP'],
                             'SN': remotePort['SN'],
                             'PORT': remotePort['MAC_TABLE']['PORT']}

            nic['REMOTE_PORT'] = refSwPort

        osUpdCollection.update_one({'OS_ID': os['OS_ID'], 'MGMT_IP': os['MGMT_IP']},
                                   {'$set':
                                    {'ETH_INTERFACES': nics}
                                    })


def genSwitchRel(db):
    cdpSrcCollection = db['COLLECT_SWITCH']
    cdpDestCollection = db['COLLECT_SWITCH']

    for swInfo in cdpSrcCollection.find({},
                                        {'MGMT_IP': 1,
                                         'SN': 1,
                                         'PORTS': 1
                                         }).batch_size(500):
        needUpdate = False
        ports = swInfo['PORTS']
        for port in ports:
            if 'NEIGHBOR' not in port or 'DEV_NAME' not in port['NEIGHBOR']:
                continue

            neighbor = port['NEIGHBOR']
            if 'DEV_NAME' in neighbor:
                remoteCount = 0
                for dev in cdpDestCollection.find({'DEV_NAME': neighbor['DEV_NAME']},
                                                  {'_OBJ_CATEGORY': 1,
                                                   '_OBJ_TYPE': 1,
                                                   'MGMT_IP': 1,
                                                   'SN': 1}
                                                  ).limit(2):
                    remoteCount = remoteCount + 1
                if remoteCount == 1:
                    needUpdate = True
                    neighbor['_OBJ_CATEGORY'] = dev['_OBJ_CATEGORY']
                    neighbor['_OBJ_TYPE'] = dev['_OBJ_TYPE']
                    neighbor['MGMT_IP'] = dev['MGMT_IP']
                    neighbor['SN'] = dev['SN']

        if needUpdate:
            cdpDestCollection.update_one({'MGMT_IP': swInfo['MGMT_IP'],
                                          'SN': swInfo['SN']},
                                         {'$set':
                                          {'PORTS': ports}
                                          })


if __name__ == "__main__":
    parser = argparse.ArgumentParser()
    parser.add_argument('--type', default='OS', help='关系类别[OS|NET]')
    args = parser.parse_args()

    (dbclient, db) = AutoExecUtils.getDB()

    try:
        if args.type == 'OS' or args.type is None:
            genInsRel(db)
            genOSSwitchRel(db)
        elif args.type == 'NET' or args.type is None:
            genSwitchRel(db)
    except Exception as ex:
        print('ERROR: Unknow Error, {}'.format(traceback.format_exc()))
        exit(-1)
    finally:
        if dbclient is not None:
            dbclient.close()
