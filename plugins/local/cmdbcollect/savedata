#!/usr/bin/python3
# -*- coding:UTF-8 -*-

import AutoExecUtils
import os
import traceback
import datetime
import argparse
import sys
import json
from bson.json_util import dumps, loads


def usage():
    pname = os.path.basename(__file__)
    print(pname + " --outputfile <path> ")
    exit(1)


def createPKIndex(collection, pkDef):
    pkIdx = []
    for field in pkDef:
        pkIdx.append((field, 1))
    collection.create_index(pkIdx, name='idx_pk', unique=True)
    collection.create_index([('_renewtime', 1)], name='idx_ttl', expireAfterSeconds=15811200)


def createIndex(collectioin, data):
    collection.create_index([('_OBJ_TYPE', 1)], name='idx_obj_type')
    if 'INDEX_FIELDS' in data:
        for idxField in data['INDEX_FIELDS']:
            collection.create_index([(idxField, 1)], name='idx_' + idxField.lower())


# 目的通过PEER信息搜索到应用进程
def saveAppConnData(db, data):
    if data['_OBJ_CATEGORY'] in ('INS', 'DB'):
        connInfo = {}
        connInfo['OS_ID'] = data['OS_ID']
        connInfo['_OBJ_CATEGORY'] = data['_OBJ_CATEGORY']
        connInfo['_OBJ_TYPE'] = data['_OBJ_TYPE']
        connInfo['MGMT_IP'] = data['MGMT_IP']
        connInfo['PORT'] = data['PORT']

        if 'RESOURCE_ID' in data:
            connInfo['RESOURCE_ID'] = data['RESOURCE_ID']
        else:
            connInfo['RESOURCE_ID'] = None

        if 'CONN_INFO' in data:
            connData = data['CONN_INFO']
            connInfo['BIND'] = connData['BIND']
            connInfo['PEER'] = connData['PEER']
        else:
            connInfo['BIND'] = []
            connInfo['PEER'] = []

        primaryKey = {'OS_ID': connInfo['OS_ID'], 'MGMT_IP': connInfo['MGMT_IP'], 'PORT': connInfo['PORT']}
        collection = db['RELATION_INS_NETCONN']
        # BIND和PEER都是简单数组，建立索引后，可以使用$in操作符进行配合，结合$elemMatch可以过滤命中的BIND和PEER
        collection.replace_one(primaryKey, connInfo, upsert=True)
        collection.create_index([('OS_ID', 1), ('MGMT_IP', 1), ('PORT', 1)], name='idx_pk')
        collection.create_index([('BIND', 1)], name='idx_bind')
        collection.create_index([('PEER', 1)], name='idx_peer')
        print('INFO: Save connection data success.')
        # del(data['CONN_INFO'])


def saveSwMacTableData(db, data):
    if data['_OBJ_CATEGORY'] == 'SWITCH' and 'MAC_TABLE' in data:
        macTableInfo = {}
        macTableInfo['_OBJ_CATEGORY'] = data['_OBJ_CATEGORY']
        macTableInfo['_OBJ_TYPE'] = data['_OBJ_TYPE']
        macTableInfo['MGMT_IP'] = data['MGMT_IP']
        macTableInfo['SN'] = data['SN']
        macTableInfo['DEV_NAME'] = data['DEV_NAME']
        if 'RESOURCE_ID' in data:
            macTableInfo['RESOURCE_ID'] = data['RESOURCE_ID']
        else:
            macTableInfo['RESOURCE_ID'] = None
        macTableInfo['MAC_TABLE'] = data['MAC_TABLE']

        primaryKey = {'MGMT_IP': macTableInfo['MGMT_IP'], 'SN': macTableInfo['SN']}
        collection = db['RELATION_NET_MACTABLE']
        collection.replace_one(primaryKey, macTableInfo, upsert=True)
        collection.create_index([('MGMT_IP', 1), ('SN', 1)], name='idx_pk')
        # MAC_TABLE_MACS索引用于使用$in操作符检索，结合$elemMatch返回匹配的MAC记录
        collection.create_index([('MAC_TABLE.MACS', 1)], name='idx_mac')
        print('INFO: Save mac table data success.')
        del(data['MAC_TABLE'])


if __name__ == "__main__":
    parser = argparse.ArgumentParser()
    parser.add_argument('--outputfile', default='', help='Output json file path for node')
    parser.add_argument('--node', default='', help='Execution node json')
    args = parser.parse_args()
    outputPath = args.outputfile

    if outputPath is None or outputPath == '':
        outputPath = os.getenv('NODE_OUTPUT_PATH')
    else:
        os.environ['NODE_OUTPUT_PATH'] = outputPath

    if outputPath is None:
        print("ERROR: Must set environment variable NODE_OUTPUT_PATH or defined option --outputfile.\n")
        usage()

    (dbclient, db) = AutoExecUtils.getDB()

    try:
        outputData = AutoExecUtils.loadNodeOutput()
        if outputData is None:
            print("WARN: Node output data is empty.")
        else:
            for key, value in outputData.items():
                if not key.startswith("cmdbcollect/"):
                    continue

                collectData = value['DATA']
                if collectData is None:
                    print('WARN: Plugin {} did not return collect data.'.format(key))
                    continue

            for data in collectData:
                # 检查数据，必须包含PK、_OBJ_CATEGORY
                isMalformData = 0
                if 'PK' not in data:
                    isMalformData = 1
                    print('WARN: Data not defined PK.')
                if '_OBJ_CATEGORY' not in data:
                    isMalformData = 1
                    print('WARN: Data not defined _OBJ_CATEGORY.')
                if isMalformData == 1:
                    print(json.dumps(data))
                    continue

                # 计算mongodb的collection名称，优先使用_OBJ_TYPE作为表名，如果没有_OBJ_TYPE则使用_OBJ_CATEGORY
                objCat = data["_OBJ_CATEGORY"]
                objType = None
                if '_OBJ_TYPE' in data:
                    objType = data['_OBJ_TYPE']

                typeName = objCat
                if objType is not None:
                    typeName = objType

                table = "COLLECT_" + objCat

                pkInvalid = False
                # 根据PK的定义生成Primary Key filter
                primaryKey = {}
                pkDef = data['PK']
                for pKey in pkDef:
                    if pKey in data:
                        pVal = data[pKey]
                        primaryKey[pKey] = data[pKey]
                        if pVal is None or pVal == '':
                            pkInvalid = True
                            print("WARN: {} PK attribute:{} is empty.".format(typeName, pKey))
                    else:
                        primaryKey[pKey] = None
                        pkInvalid = True
                        print("WARN: {} not contain PK attribute:{}.".format(typeName, pKey))

                if pkInvalid:
                    continue

                pkJson = json.dumps(primaryKey)
                collection = db[table]
                #record = collection.find_one(primaryKey, {'data': True})
                try:
                    print('INFO: Begin save data {}:{} ...'.format(typeName, pkJson))
                    currentTime = datetime.datetime.utcnow()
                    data['_updatetime'] = currentTime
                    data['STATE'] = 'InUse'
                    data['_renewtime'] = currentTime
                    if '_OBJ_CATEGORY' in data:
                        saveAppConnData(db, data)
                        saveSwMacTableData(db, data)
                    print('INFO: Save connection information success.')
                    collection.replace_one(primaryKey, data, upsert=True)
                    print('INFO: Save data success.')
                    createPKIndex(collection, pkDef)
                    createIndex(collection, data)
                    print('INFO: Save data success.\n'.format(typeName, pkJson))
                except Exception as ex:
                    print('ERROR: Save data for {}({}) failed, {}'.format(typeName, pkJson, ex))
                    traceback.print_exc()
    except Exception as ex:
        print('ERROR: Unknow Error, {}'.format(ex))
        exit(-1)
    finally:
        if dbclient is not None:
            dbclient.close()
