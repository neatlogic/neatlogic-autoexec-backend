#!/usr/bin/python3
# -*- coding: utf-8 -*-

import json
from pathlib import Path
import subprocess
import AutoExecUtils
import Utils
import os
import sys
import time
import argparse
from pyquery import PyQuery

binPaths = os.path.split(os.path.realpath(__file__))
libPath = os.path.realpath(binPaths[0]+'/../lib')
sys.path.append(libPath)


if __name__ == "__main__":

    # for key, value in os.environ.items():
    #     print(key + " : " + value)
    # 参数处理
    parser = argparse.ArgumentParser()
    parser.add_argument('--startdir', default='', help='dependency check startdir')
    parser.add_argument('--cveValidForHours', default='168', help='cve valid for hours')
    parser.add_argument('--cveUrlModified', default='', help='URL for the modified CVE JSON data feed. When mirroring the NVD you must mirror the *.json.gz and the *.meta files. Optional if your custom')
    parser.add_argument('--cveUrlBase', default='', help='Base URL for each year\'s CVE JSON data feed, the %d will be replaced with the year')

    args = parser.parse_args()

    project_path = os.environ.get('PRJ_PATH')
    if not project_path or not Path(project_path).exists():
        print('ERROR: project path not found')
        exit(1)

    startdir = str(Path(project_path) / args.startdir)
    if not project_path or not Path(project_path).exists():
        print('ERROR: startdir path not found')
        exit(1)

    result = subprocess.run([os.environ['TOOLS_PATH'] + '/dependency-check/bin/dependency-check.sh', '--cveUrlModified', args.cveUrlModified, '--cveUrlBase', args.cveUrlBase,
                            '--cveValidForHours', args.cveValidForHours, '-s', startdir, '-o', startdir], stderr=subprocess.STDOUT)

    # print(result)
    # print(result.returncode)
    if result.returncode == 0:
        print("FINE: Execute dependency-check success\n")

        post_data = {}
        post_data['version'] = os.environ.get('VERSION')
        post_data['appSystemId'] = int(os.environ.get('SYS_ID'))
        post_data['appModuleId'] = int(os.environ.get('MODULE_ID'))
        post_data['cveList'] = []

        data = (Path(startdir) / 'dependency-check-report.html').read_text(encoding='utf-8')
        doc = PyQuery(data)

        tr_list = doc('#summaryTable').find('tr').items()
        for tr in tr_list:
            if len(tr.find('td')) == 0 or not tr.hasClass('vulnerable'):
                continue

            cve = {}
            cve['dependency'] = tr.find('td').eq(0).find('a').text()
            cve['vulnerabilityIds'] = []
            if tr.find('td').eq(1).find('a').length > 0:
                # 有可能没有a，只有文本
                for vuln in tr.find('td').eq(1).find('a').items():
                    cve['vulnerabilityIds'].append({
                        'vulnerabilityId': vuln.text(),
                        'url': vuln.attr('href')
                    })
            else:
                # 需要测试，当vulnerabilityIds没有出现url，且当vulnerabilityIds有多条的情况
                if tr.find('td').eq(1).text():
                    cve['vulnerabilityIds'].append({
                        'vulnerabilityId': tr.find('td').eq(1).text(),
                        'url': ''
                    })

            cve['packageList'] = []
            if tr.find('td').eq(2).find('a').length > 0:
                for vuln in tr.find('td').eq(2).find('a').items():
                    cve['packageList'].append({
                        'packageName': vuln.text(),
                        'url': vuln.attr('href')
                    })
            else:
                if tr.find('td').eq(2).text():
                    cve['packageList'].append({
                        'packageName': tr.find('td').eq(2).text(),
                        'url': ''
                    })

            cve['highestSeverity'] = tr.find('td').eq(3).text()
            cve['cveCount'] = int(tr.find('td').eq(4).text())
            cve['confidence'] = tr.find('td').eq(5).text()
            cve['evidenceCount'] = int(tr.find('td').eq(6).text())
            post_data['cveList'].append(cve)

        AutoExecUtils.saveOutput(post_data)
        AutoExecUtils.saveLiveData(post_data)

        retObj = AutoExecUtils.saveVersionCveList(post_data)
        if retObj.get('Status') == 'OK':
            print('INFO: save version dependency check report finished')
        else:
            print('ERROR: save version dependency check report failed, error: '+str(retObj))
            exit(1)

    exit(result.returncode)
