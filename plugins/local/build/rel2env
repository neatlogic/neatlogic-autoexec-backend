#!/usr/bin/perl
use strict;
use FindBin;
use File::Basename;
use Cwd;
use Getopt::Long;

use DeployUtils;
use ServerAdapter;

Getopt::Long::Configure("pass_through");

sub usage {
    my $pname = basename($0);
    print("Usage: $pname [-v|--verbose 0|1] [--envpath EnvPath] [--version VERSION]\n");
    print("\n");
    print("       --envpath: Env path in the data directory, example:10/10/10\n");

    exit(1);
}

sub main {
    my ( $isHelp, $isVerbose, $envPath, $version );
    my $pname = $FindBin::Script;

    GetOptions(
        'h|help'      => \$isHelp,
        'envpath=s'   => \$envPath,
        'version=s'   => \$version,
        'v|verbose=i' => \$isVerbose
    );
    usage() if ( defined($isHelp) );
    my $optionError = 0;

    my $buildEnv  = DeployUtils->deployInit( $envPath, $version );
    my $namePath  = $buildEnv->{NAME_PATH};
    my $dataPath  = $buildEnv->{DATA_PATH};
    my $buildNo   = $buildEnv->{BUILD_NO};
    my $envName   = $buildEnv->{ENV_NAME};
    my $isRelease = $buildEnv->{IS_RELEASE};
    my $buildDir  = "$dataPath/artifact/$version/build/$buildNo";
    my $syncDir   = "$dataPath/artifact/$version/env/$envName";

    if ( not defined($envPath) or not defined($version) ) {
        print("ERROR: must defined option --envpath and --version.\n");
        $optionError = 1;
    }

    usage() if ( $optionError == 1 );

    if ( $isRelease != 1 ) {
        print("ERROR: $namePath version:$version build $buildNo is not released, can not release to env.\n");
        return 3;
    }

    my $ret = 0;
    if ( -e "$syncDir/app" ) {
        $ret = system("rm -rf '$syncDir/app'");
    }

    if ( $ret != 0 ) {
        return $ret;
    }

    if ( -e "$syncDir/db" ) {
        $ret = system("rm -rf '$syncDir/db'");
    }

    if ( $ret != 0 ) {
        return $ret;
    }

    if ( -e "$syncDir/doc" ) {
        $ret = system("rm -rf '$syncDir/doc'");
    }

    if ( $ret != 0 ) {
        return $ret;
    }

    if ( -d "$buildDir/app" ) {
        $ret = system("cp -rf '$buildDir/app' '$syncDir/'");
    }

    if ( $ret != 0 ) {
        return $ret;
    }

    if ( -d "$buildDir/db" ) {
        $ret = system("cp -rf '$buildDir/db' '$syncDir/'");
    }

    if ( $ret != 0 ) {
        return $ret;
    }

    if ( -d "$buildDir/doc" ) {
        $ret = system("cp -rf '$buildDir/doc' '$syncDir/'");
    }

    return $ret;
}

exit main();

