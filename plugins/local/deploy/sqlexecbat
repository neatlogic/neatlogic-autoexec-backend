#!/usr/bin/perl
use strict;
use FindBin;
use Cwd;
use Getopt::Long;

use DeployUtils;
use ServerAdapter;

Getopt::Long::Configure("pass_through");

sub usage {
    my $pname = $FindBin::Script;

    print("Usage: $pname [-v 0|1] [--envpath EnvPath] [--version VERSION]\n");
    print("              [--index IndexFilePattern] [--filter SqlFilePattern]\n");
    print("              [--dryrun 0|1] [--rollback 0|1] [--autocommit 0|1]\n");
    print("              [--dbversion DBVersion] [--dbargs DBArguments]\n");
    print("              [--checkinrole <role name>] <sql file:sid.user/1.ddl.a.sql>\n");
    print("\n");
    print("       dryrun:      only test, not realy execute the sql script\n");
    print("       autocommit:  permit autocommit on mysql, postgresql\n");
    print("       rollback:    just execute the rollback scripts\n");
    print("       envpath:     subsys environment path, example:ATM/ATMP/PRD\n");
    print("       version:     version number for the version\n");
    print("       dbVersion:   db major version number, example:orale 11g, --dbversion 11\n");
    print("       dbArgs:      db client tool extend arguments, example:oracle, --dbargs 'fully=y'\n");
    print("       index:       index file's patterns, example: asmdb.root/run/idx.sql\n");
    print("       filter:      filter the sql script file by the subdirectory under the schema\n");
    print("       sql file:    sql script file\n");

    exit(1);
}

sub main {
    my ( $isHelp, $isVerbose, $lang, $envPath, $version );
    my ( $baseDir, $cmd );
    my $pname = $FindBin::Script;

    GetOptions(
        'h|help'      => \$isHelp,
        'envpath=s'   => \$envPath,
        'version=s'   => \$version,
        'lang=s'      => \$lang,
        'v|verbose=i' => \$isVerbose,
        'basedir=s'   => \$baseDir,
        'cmd=s'       => \$cmd
    );
    usage() if ( defined($isHelp) );
    usage() if ( not defined($cmd) or $cmd eq '' );
    my $optionError = 0;

    my $buildEnv  = DeployUtils->deployInit( $envPath, $version );
    my $namePath  = $buildEnv->{NAME_PATH};
    my $dataPath  = $buildEnv->{DATA_PATH};
    my $toolsPath = $buildEnv->{TOOLS_PATH};

    if ( not defined($envPath) or not defined($version) ) {
        print("ERROR: must defined option --envpath and --version.\n");
        $optionError = 1;
    }

    usage() if ( $optionError == 1 );

    if ( not defined($baseDir) ) {
        $baseDir = Cwd::realpath($dataPath);
    }
    else {
        $baseDir = Cwd::realpath("$dataPath/$baseDir");
    }

    my $isFail = 0;
    if ( system("$toolsPath/hook-fmod/ezdplyfssb -b '$baseDir' -- $cmd") != 0 ) {
        print("ERROR: exec $cmd has error.\n");
        $isFail = 1;
    }
    else {
        print("INFO: exec $cmd has successed.\n");
    }

    return $isFail;
}

exit main();

